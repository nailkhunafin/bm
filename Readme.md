## ТЗ для команды SuperPay.

- Все вызовы должны быть идемпотентны для  merchant_id
- Нужен тестовая карточка или токен для тестирования интеграций
- Уточнить ожидаемый SLA
- В параметрах 
- Ручка callback о статусе платежа 
```json
{  
    "merchant_id": "123456",
    "id": "22979b7b-000f-5000-9000-1a603a795739",
    "test": false,
    "amount": {
      "value": "2.00",
      "currency": "RUB"
    },
    "error": {
      "code": "blocked",
      "description": "Some description"
    },
     "status":"ERROR",
     "accepted_at":"2018-05-23T15:24:43.812Z",
     "processed_at":"2018-05-23T15:24:43.812Z",
     "sign": "asdklajdkajdkjal"
}
```
- Договорится как будут ходить в  callback. 
   Ретраить в случае 500 или 403. 
- Желаемый формат ответа при запросе статуса платежа или создании платежа:

**pay_url** - опционально
**processed_at** - опционально
**error** - опционально
```json
{
  "id": "22979b7b-000f-5000-9000-1a603a795739",
  "merchant_id": "123456",
  "status": "PENDING",
  "amount": {
    "value": "2.00",
    "currency": "RUB"
  },
  "accepted_at": "2018-05-23T15:24:43.812Z",
  "processed_at": "2018-05-23T15:24:43.812Z",
  "test": false,
  "error": {
    "code": "blocked",
    "description": "Some description"
  },
  "pay_url": "https://superpay.com/pay?pay_id=22979b7b-000f-5000-9000-1a603a795739"
}
```


## Структура реляционной базы для хранения всех необходимых данных в рамках интеграции с SuperPay.

Wallet:
+ id
+ user_id
+ amount


WalletActions:
+ id
+ merchant_id
+ sum
+ action
+ created_at
+ status
+ metadata


## Код для вывода средств 
* _payout.py_
* _tests.py_

## Описать флоу, архитектуру просто текстом. 

Для пополнения счета:
1. Делаем запрос в платежную систему
1. Запоминаем id платежа  
1. Каждые n секунд обходим платежи с промежуточным статусом и ставим задачу на опрос уточнение статус платежа
+ если статус OK обновляем счет кошелька и отмечаем платеж исполненным
+ если платеж отменен, то помечаем платеж как неудачный


Для вывода денег со счета:
1. Проверяем что возможен вывод указанной суммы
1. Резервируем сумму в кошельке (пользователь сразу видит уменьшение баланса)
1. Ставим задачу на вывод средств



Задача для вывода средств:
1. Делаем запрос в платежную систему 
1. Запоминаем id платежа  
1. Каждые n секунд обходим платежи с промежуточным статусом и ставим задачу на опрос уточнение статус платежа:
    + если статус OK обновляем счет кошелька и отмечаем платеж исполненным
    + если платеж отменен, то помечаем платеж как неудачный и возвращаем замороженную сумму на кошелек


Мониторинг:
+ коды ответов от SuperPay
+ время ответов от SuperPay
+ задачи по взаимодействию с SuperPay:
    1. количество в очереди
    1. количество удачных
    1. количество ошибочных
+ количество необработанных платежей
     
